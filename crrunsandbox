#!/usr/bin/python

import multiprocessing
import os
import re
import subprocess
import sys
import util

from optparse import OptionParser

# Options

parser = OptionParser()
parser.add_option("-v", "--verbose", dest="verbose",
                  action="store_true",
                  help="show verbose messages")
parser.add_option("-d", "--dryrun", dest="dryrun",
                  action="store_true",
                  help="dry run, log what we plan to do it but don't actually do anything")

(options, args) = parser.parse_args()

# TODO: hide compilation output.

HOME = os.path.expanduser("~")
GOMA_DIR = os.path.join(HOME, "goma")
TEST_USER_PROFILE_PATH = os.path.join(HOME, "tmp", "test-sandbox")
GN_ARGS = [
  'target_os = "chromeos"',
  'is_component_build = true',
  'enable_nacl = false',
  'use_goma = true',
  'goma_dir="' + GOMA_DIR  + '"',
]

util.ensure_goma_installed()

n_cpus = multiprocessing.cpu_count()
n_threads = max(1, n_cpus - 1)
n_jobs = 10 * n_threads

os.chdir(os.path.join(HOME, "chromium", "src"))
cmd = "gn gen out_cros/Release --args='" + " ".join(GN_ARGS) + "'"
print("Running gn gen...")
os.system(cmd)

# TODO: Run goma if it's not running.
if not util.is_process_running("compiler_proxy"):
  print("\n\n-- Warning: goma is not running, the build will be "
         "slower and may not work. Start goma with ~/goma/compiler_proxy --\n\n")
cmd = ("ninja -C out_cros/Release -j" + str(n_jobs) +
       " chrome chrome_sandbox")
print("Compiling, this might take a while...")
util.system_silent(cmd, options)

sbin_target = "/usr/local/sbin/chrome-devel-sandbox"
if not os.path.exists(sbin_target):
  os.system("sudo cp out_cros/Release/chrome_sandbox " + sbin_target)
  os.system("sudo chown root:root /usr/local/sbin/chrome-devel-sandbox")
  os.system("sudo chmod 4755 /usr/local/sbin/chrome-devel-sandbox")

#TODO: Make the data dir configurable
cmd = "out_cros/Release/chrome --user-data-dir=" + TEST_USER_PROFILE_PATH
print("Running chrome...")
util.system_silent(cmd, options)
